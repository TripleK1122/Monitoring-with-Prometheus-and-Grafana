name: Monitoring Stack CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # üß± 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4

      # üê≥ 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # üîç 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å docker-compose.yml
      - name: Validate docker-compose syntax
        run: docker compose config

      # üß© 4. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      - name: Build all Docker services
        run: docker compose build

      # üì¶ 5. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ—Å—å —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
      - name: Run services (detached)
        run: docker compose up -d

      # üïê 6. –î–∞–µ–º –≤—Ä–µ–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
      - name: Wait for containers to start
        run: sleep 15

      # üîé 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
      - name: Check running containers
        run: docker ps -a

      # ‚úÖ 8. –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Prometheus –∏ Grafana
      - name: Test Prometheus and Grafana endpoints
        run: |
          echo "Checking Prometheus..."
          curl -f http://localhost:9090 || (echo "‚ùå Prometheus not responding" && exit 1)
          echo "‚úÖ Prometheus OK"

          echo "Checking Grafana..."
          curl -f http://localhost:3000/login || (echo "‚ùå Grafana not responding" && exit 1)
          echo "‚úÖ Grafana OK"

      # üßπ 9. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É –∏ —á–∏—Å—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã
      - name: Stop and clean up
        if: always()
        run: docker compose down -v
